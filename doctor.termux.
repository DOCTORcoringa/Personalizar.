import os
from rich.console import Console
from rich.panel import Panel
from rich.prompt import Prompt, IntPrompt
from pyfiglet import Figlet

console = Console()

FONT_OPTIONS = {
    1: 'standard', 2: 'slant', 3: 'block', 4: 'banner',
    5: '3d', 6: 'big', 7: 'doom'
}
PANEL_COLORS = ['red', 'green', 'blue', 'yellow', 'purple', 'cyan', 'white']

def clear_screen():
    os.system('clear' if os.name == 'posix' else 'cls')

def show_creator_message():
    clear_screen()
    texto = ("Criado por Doctor Coringa Lunático\n"
             "O mestre das linhas de código obscuras\n"
             "Aperte Enter para continuar...")
    console.print(Panel(texto, title="[bold green]Mensagem do Criador[/bold green]", style="green"))
    input()

def get_name():
    console.print(Panel("Digite seu nome para o banner:", style="bold blue"))
    return Prompt.ask("")

def select_font():
    console.print(Panel("\nEscolha a fonte do banner:\n" +
        "\n".join(f"[cyan]{k}[/cyan]) {v.capitalize()}" for k,v in FONT_OPTIONS.items()), style="green"))
    while True:
        escolha = IntPrompt.ask("Escolha uma opção", choices=[str(k) for k in FONT_OPTIONS.keys()], show_choices=False)
        if int(escolha) in FONT_OPTIONS:
            return FONT_OPTIONS[int(escolha)]
        console.print("[red]Opção inválida! Tente novamente.[/]")

def select_color():
    console.print(Panel("\nEscolha a cor do painel:\n" +
        "\n".join(f"[{color}]{i}) {color.capitalize()}[/]" for i, color in enumerate(PANEL_COLORS, 1)), style="green"))
    while True:
        escolha = IntPrompt.ask("Escolha uma opção", choices=[str(i) for i in range(1, len(PANEL_COLORS)+1)], show_choices=False)
        escolha_int = int(escolha)
        if 1 <= escolha_int <= len(PANEL_COLORS):
            return PANEL_COLORS[escolha_int - 1]
        console.print("[red]Opção inválida! Tente novamente.[/]")

def ask_password():
    resp = Prompt.ask("Deseja criar uma senha para proteger o Termux? (s/n)", choices=["s","n"], default="n", show_choices=False)
    if resp == "s":
        while True:
            senha = Prompt.ask("Digite a senha", password=True)
            confirma = Prompt.ask("Confirme a senha", password=True)
            if senha == confirma:
                return senha
            console.print("[red]Senhas não conferem! Tente novamente.[/]")
    return ""

def get_prompt_name(default_name):
    console.print(Panel("Digite o texto do prompt (linha de comando):", style="bold magenta"))
    texto_prompt = Prompt.ask(f"Texto do prompt (padrão: {default_name})", default=default_name)
    return texto_prompt

def create_panel(name, font, color):
    f = Figlet(font=font)
    ascii_art = f.renderText(name)
    painel = Panel(
        ascii_art,
        title=f"[{color}]Painel de Pré-visualização[/]",
        subtitle=f"Seu nome, [bold]{name}[/bold], com a fonte '{font.capitalize()}'",
        style=color
    )
    console.print(painel)

def save_bashrc(name, font, prompt_name, senha):
    home = os.path.expanduser("~")
    flag_msg_file = os.path.join(home, ".termux_msg_flag")

    bashrc_content = f"""
clear

# Arquivo .bashrc gerado pelo painel_termux.py

typed_text() {{
  texto="$1"
  delay=${{2:-0.07}}
  for ((i=0; i<${{#texto}}; i++)); do
    echo -n "${{texto:i:1}}"
    sleep $delay
  done
  echo ""
}}

# Mensagem do criador só aparece se flag não existir
if [ ! -f "{flag_msg_file}" ]; then
  typed_text "Criado por Doctor Coringa Lunático..."
  typed_text "O mestre das linhas de código obscuras."
  typed_text "Aqui começa sua jornada hacker."
  touch "{flag_msg_file}"
  sleep 1
  clear
fi

figlet -f "{font}" "{name}"

if [ ! -z "{senha}" ]; then
  for i in {{1..3}}; do
    read -s -p "Digite a senha para continuar: " input_senha
    echo
    if [ "$input_senha" = "{senha}" ]; then
      break
    else
      echo "Senha incorreta. Tente novamente."
    fi
    if [ $i -eq 3 ]; then
      echo "Falha na autenticação, saindo..."
      exit 1
    fi
  done
fi

# Prompt estilizado com nome escolhido
export PS1="\\[\\033[1;32m\\]{prompt_name} \\[\\033[0m\\]\\$ "
"""

    bashrc_path = os.path.join(home, ".bashrc")
    with open(bashrc_path, "w") as file:
        file.write(bashrc_content)

def main_menu():
    current_name = "Convidado"
    current_font = FONT_OPTIONS[1]
    current_color = PANEL_COLORS[1]
    current_password = ""
    current_prompt_name = current_name

    show_creator_message()

    while True:
        clear_screen()
        console.print(Panel(
            "[bold cyan]Painel de Personalização do Termux[/bold cyan]\n"+
            "Escolha uma opção para personalizar seu terminal",
            subtitle="Digite o número da opção desejada e pressione Enter",
            style="green"
        ))

        console.print(f"\n  [1]) Alterar Nome (Atual: [bold green]{current_name}[/bold green])")
        console.print(f"  [2]) Alterar Fonte do Banner (Atual: [bold green]{current_font}[/bold green])")
        console.print(f"  [3]) Alterar Cor do Painel (Atual: [bold green]{current_color}[/bold green])")
        console.print(f"  [4]) Configurar Senha (Atual: [bold red]{'Não configurada' if not current_password else 'Configurada'}[/bold red])")
        console.print(f"  [5]) Alterar Texto do Prompt (Atual: [bold magenta]{current_prompt_name}[/bold magenta])")
        console.print("  [6]) Visualizar Painel")
        console.print("  [7]) Salvar e Sair")
        console.print("  [8]) Sair sem Salvar\n")

        choice = IntPrompt.ask("Escolha uma opção", choices=[str(i) for i in range(1,9)], show_choices=False)

        if choice == 1:
            current_name = get_name()
        elif choice == 2:
            current_font = select_font()
        elif choice == 3:
            current_color = select_color()
        elif choice == 4:
            current_password = ask_password()
        elif choice == 5:
            current_prompt_name = get_prompt_name(current_prompt_name)
        elif choice == 6:
            clear_screen()
            create_panel(current_name, current_font, current_color)
            Prompt.ask("\nPressione Enter para voltar ao menu")
        elif choice == 7:
            clear_screen()
            save_bashrc(current_name, current_font, current_prompt_name, current_password)
            console.print("[green]Configuração salva! Reinicie o Termux para aplicar.[/green]\n")
            break
        elif choice == 8:
            console.print("[yellow]Saindo sem salvar as alterações.[/yellow]\n")
            break

if __name__ == "__main__":
    main_menu()
